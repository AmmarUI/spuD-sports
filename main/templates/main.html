{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>spuD Sports</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-gradient-to-br from-[#7c5295] via-[#000000] to-[#d71515] w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">Sports Essentials</h1>
      <p class="text-white">The best online store for all your sporting needs</p>
    </div>

    <!-- AJAX Controls -->
    <div class="flex items-center gap-3 mb-4">
      <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-white text-green-600 font-semibold outline outline-2 outline-green-600 outline-offset-[-2px] rounded-md hover:bg-green-600 hover:text-white transition-colors">
        Create Product (AJAX)
      </button>
      <button id="refresh-btn" class="inline-flex items-center px-3 py-2 border rounded-md text-white">Refresh</button>
    </div>

    <!-- Loading, Error, Empty, Grid -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>
    <div id="error" class="hidden text-red-600 p-4"></div>
    <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Create the first product using the button above.</p>
    </div>
    <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
  </div>
</div>

<script>
  const ITEM_API_ENDPOINT = "{% url 'main:show_json' %}";
  const DELETE_API_ENDPOINT = "{% url 'main:delete_item_ajax' %}";
  const refreshBtn = document.getElementById('refresh-btn');
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const emptyEl = document.getElementById('empty');
  const gridEl = document.getElementById('grid');

  function showSection({loading=false, error=false, empty=false, grid=false}) {
    loadingEl.classList.toggle('hidden', !loading);
    errorEl.classList.toggle('hidden', !error);
    emptyEl.classList.toggle('hidden', !empty);
    gridEl.classList.toggle('hidden', !grid);
  }
  function categoryLabel(code) {
    const map = {shoes:'Shoes', balls:'Balls', jerseys:'Jerseys', socks:'Socks', shorts:'Shorts'};
    return map[code] || code;
  }
  function buildCard(item) {
    const card = document.createElement('a');
    card.href = `/item/${item.id}`;
    card.className = `
      bg-gradient-to-br from-gray-900 via-gray-800 to-black
      rounded-lg border border-white/20
      overflow-hidden flex flex-col
      transform transition duration-200 hover:scale-105 hover:shadow-lg
      w-full max-w-xs
      h-64 sm:h-72 md:h-80   /* responsive card heights */
    `;

    const thumb = item.thumbnail
      ? `<div class="w-full h-28 sm:h-32 md:h-40 overflow-hidden">
          <img src="${item.thumbnail}" alt="${item.name}"
                class="w-full h-full object-cover object-center">
        </div>`
      : `<div class="w-full h-28 sm:h-32 md:h-40 bg-gray-700"></div>`;

    const featured = item.is_featured
      ? `<span class="inline-flex items-center px-2 py-1 rounded text-[0.65rem] sm:text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>`
      : '';

    card.innerHTML = `
      ${thumb}
      <div class="p-2 sm:p-3 md:p-4 flex flex-col justify-between flex-1">
        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[0.65rem] sm:text-xs md:text-sm font-medium bg-green-600 text-white">
              ${categoryLabel(item.category)}
            </span>
            <div class="flex gap-2">${featured}</div>
          </div>
          <h3 class="font-semibold mb-2 text-gray-100 
                    text-sm sm:text-base md:text-lg 
                    line-clamp-1 sm:line-clamp-2">
            ${item.name}
          </h3>
        </div>
        <div class="flex items-center justify-between text-purple-400">
          <span class="font-semibold text-sm sm:text-base md:text-lg">$ ${item.price}</span>
          <div class="flex gap-3">
            <button class="text-gray-200 hover:text-gray-400 text-xs sm:text-sm md:text-base" 
                    onclick='showModal(${JSON.stringify({})})'>Edit</button>
            <button class="text-red-500 hover:text-red-700 text-xs sm:text-sm md:text-base" 
                    onclick="handleDelete('${item.id}')">Delete</button>
          </div>
        </div>
      </div>
    `;

    return card;
  }

  function renderItems(items) {
    gridEl.innerHTML = '';
    if (!items || items.length === 0) {
      showSection({empty:true});
      return;
    }
    items.forEach(item => gridEl.appendChild(buildCard(item)));
    showSection({grid:true});
  }
  async function fetchItems() {
    try {
      showSection({loading:true});
      const res = await fetch(ITEM_API_ENDPOINT, {headers: {'Accept':'application/json'}});
      if (!res.ok) throw new Error('Failed to load items');
      const data = await res.json();
      renderItems(data);
    } catch (e) {
      errorEl.textContent = e.message;
      showSection({error:true});
    }
  }
  async function handleDelete(id) {
    if (!confirm('Delete this product?')) return;
    const form = new FormData();
    form.append('id', id);
    const res = await fetch(DELETE_API_ENDPOINT, {method:'POST', body: form});
    if (res.ok) {
      showToast('Product deleted', '', 'success');
      setTimeout(() => {
        document.dispatchEvent(new CustomEvent('itemsChanged'));
      }, 1200);
    } else {
      showToast('Delete failed', '', 'error');
    }

  }
  refreshBtn.addEventListener('click', fetchItems);
  document.addEventListener('itemsChanged', fetchItems);
  fetchItems();
</script>
{% endblock content %}
